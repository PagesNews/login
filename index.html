<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Salud Felina | Panleucopenia</title>

<style>
/* Reset y base */
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:Arial, sans-serif;
  background:#f3f7f6;
  color:#2e3d38;
  line-height:1.8;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  padding-bottom:40px;
  cursor: default;
}

/* Encabezado */
header{
  background:linear-gradient(90deg,#cfe7df,#e6f2ef);
  padding:50px 20px;
  text-align:center;
  border-bottom:1px solid rgba(0,0,0,.04);
}
header h1{font-size:28px;margin-bottom:8px}
header p{opacity:.9}

/* Contenedor principal */
.container{
  max-width:1100px;
  margin:30px auto;
  padding:0 20px;
}

/* Tarjetas y grid */
.card{
  background:white;
  padding:28px;
  border-radius:14px;
  margin-bottom:24px;
  box-shadow:0 8px 20px rgba(0,0,0,.06);
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:20px;
  align-items:center;
}

/* Im√°genes */
img{
  width:100%;
  border-radius:12px;
  display:block;
}

/* Tipograf√≠a */
h2{color:#2f6b5d;margin-bottom:12px}
h3{color:#3e6f5f;margin-bottom:8px;font-size:18px}
p{margin-bottom:10px}

/* Formularios */
label{display:block;margin-top:10px;font-size:13px;color:#4f6a62}
input,button,textarea,select{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:8px;
  border:1px solid #d0d8d4;
  font-size:14px;
}
input:focus,textarea:focus,select:focus{outline:none;border-color:#9ecdbf;box-shadow:0 0 0 3px rgba(154,206,191,.12)}
button{
  background:#2f8c74;
  color:white;
  border:none;
  cursor:pointer;
  padding:12px;
  transition:background .18s;
}
button:hover{background:#277a64}
button[disabled]{opacity:.6;cursor:not-allowed}

/* Oculto por clases */
.hidden{display:none}

/* Divider */
.divider{
  text-align:center;
  margin:18px 0;
  position:relative;
  color:#7d8b86;
}
.divider::before,
.divider::after{
  content:"";
  position:absolute;
  top:50%;
  width:40%;
  height:1px;
  background:#e0e6e3;
}
.divider::before{left:0}
.divider::after{right:0}

/* Password wrapper: toggle abajo */
.password-wrapper{position:relative}
.toggle-password{
  display:inline-block;
  margin-top:8px;
  background:transparent;
  border:1px solid #d0d8d4;
  padding:8px 10px;
  border-radius:8px;
  cursor:pointer;
  color:#46685d;
  font-size:14px;
}
.toggle-password:focus{outline:2px solid rgba(63,150,123,.18)}

/* Strength meter */
.pw-requirements{font-size:13px;color:#60736d;margin-top:8px}
.pw-requirements li{margin:6px 0;list-style:disc;margin-left:18px}
.pw-meter{height:10px;border-radius:6px;background:#e9f3ee;overflow:hidden;margin-top:8px}
.pw-meter > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#ff8a65,#4caf50);transition:width .2s}

/* Small decorative info */
.kv{display:flex;gap:12px;align-items:flex-start}
.kv img{width:72px;height:72px;object-fit:cover;border-radius:10px}

/* Footer */
footer{max-width:1100px;margin:20px auto;text-align:center;color:#61726c;font-size:13px}

/* Responsiveness tweaks */
@media (max-width:480px){
  header{padding:28px 12px}
  .card{padding:18px}
}
</style>
</head>

<body>

<header>
  <h1>Panleucopenia Felina üêæ</h1>
  <p>Informaci√≥n veterinaria clara y recursos para proteger a tu gato</p>
</header>

<div class="container">

  <!-- LOGIN -->
  <section id="loginSection" class="card" style="max-width:520px;margin:0 auto 24px;">
    <h2>Iniciar sesi√≥n / Registrarse</h2>

    <label for="email">Correo electr√≥nico</label>
    <input id="email" type="email" placeholder="tu@correo.com" autocomplete="email">

    <label for="password">Contrase√±a</label>
    <div class="password-wrapper">
      <input id="password" type="password" placeholder="Contrase√±a" autocomplete="current-password" aria-describedby="pwHelp">
      <!-- El bot√≥n ya no est√° encima del input: est√° debajo -->
      <button id="togglePassword" class="toggle-password" aria-label="Mostrar contrase√±a" aria-pressed="false">üëÅÔ∏è Mostrar contrase√±a</button>

      <div id="pwHelp" class="pw-requirements" aria-live="polite">
        <p style="margin-bottom:6px;font-weight:600;color:#2f6b5d">Requisitos m√≠nimos (pol√≠tica: nivel medio)</p>
        <ul>
          <li id="req-length">Al menos 8 caracteres</li>
          <li id="req-classes">Al menos 3 de: min√∫sculas, may√∫sculas, n√∫meros, s√≠mbolos</li>
        </ul>

        <div class="pw-meter" aria-hidden="true" title="Indicador de fuerza de contrase√±a">
          <i id="pwBar" style="width:0%"></i>
        </div>

        <p id="pwFeedback" style="margin-top:8px;color:#6a7f78;font-size:13px">Introduce una contrase√±a para ver la fuerza.</p>
      </div>
    </div>

    <button id="registerBtn" disabled>Registrarme</button>
    <button id="loginBtn" style="margin-top:8px;background:#4a7c6a">Iniciar sesi√≥n</button>

    <div class="divider">o</div>

    <button id="googleBtn" style="background:#de5246">Continuar con Google</button>

    <p id="authMsg" style="margin-top:12px;color:#3e5f56"></p>
  </section>

  <!-- CONTENIDO PRINCIPAL -->
  <section id="contenido" class="hidden">
    <div class="card grid">
      <div>
        <h2>¬øQu√© es la Panleucopenia Felina?</h2>
        <p>
          La panleucopenia felina es una enfermedad viral grave causada por un parvovirus que ataca las c√©lulas en divisi√≥n r√°pida,
          incluyendo la m√©dula √≥sea y el tracto intestinal. Es especialmente peligrosa en gatitos y en gatos no vacunados.
        </p>

        <h3>S√≠ntomas comunes</h3>
        <ul>
          <li>Fiebre, letargo y p√©rdida de apetito</li>
          <li>V√≥mitos y diarrea severa (a menudo con sangre)</li>
          <li>Deshidrataci√≥n r√°pida y leucopenia (baja en gl√≥bulos blancos)</li>
        </ul>

        <h3>Prevenci√≥n</h3>
        <p>
          La prevenci√≥n eficaz es la vacunaci√≥n. Sigue el calendario de vacunaci√≥n recomendado por el veterinario y evita contacto
          con animales posiblemente infectados.
        </p>

        <h3>Tratamiento</h3>
        <p>
          No existe un tratamiento antiviral espec√≠fico ampliamente disponible; el manejo es de soporte: fluidoterapia, control de
          infecciones secundarias y cuidados intensivos. La intervenci√≥n temprana mejora significativamente el pron√≥stico.
        </p>
      </div>
      <div>
        <img src="https://images.unsplash.com/photo-1518791841217-8f162f1e1131?auto=format&fit=crop&w=900&q=80" alt="Gato descansando" onerror="this.onerror=null;this.src='https://picsum.photos/seed/cat1/900/600'">
        <p style="margin-top:8px;color:#5b736a;font-size:14px">La vacunaci√≥n protege contra la panleucopenia; consulta a tu veterinario.</p>
      </div>
    </div>

    <div class="card grid">
      <div>
        <h2>Recomendaciones pr√°cticas</h2>
        <div class="kv" style="margin-bottom:10px">
          <img src="https://images.unsplash.com/photo-1517423440428-a5a00ad493e8?auto=format&fit=crop&w=300&q=80" alt="vacunacion" onerror="this.onerror=null;this.src='https://picsum.photos/seed/cat2/300/300'">
          <div>
            <strong>Vacunaci√≥n:</strong>
            <p style="margin-top:6px">Sigue el calendario para gatitos y refuerzos anuales. Las vacunas reducen dr√°sticamente la mortalidad.</p>
          </div>
        </div>

        <div class="kv">
          <img src="https://images.unsplash.com/photo-1519402450569-82d2ffb3f24f?auto=format&fit=crop&w=300&q=80" alt="higiene" onerror="this.onerror=null;this.src='https://picsum.photos/seed/cat3/300/300'">
          <div>
            <strong>Higiene y aislamiento:</strong>
            <p style="margin-top:6px">Aislar a los animales enfermos y desinfectar superficies; el virus resiste en el ambiente.</p>
          </div>
        </div>
      </div>

      <div>
        <h3>¬øCu√°ndo acudir al veterinario?</h3>
        <p>
          Si observas v√≥mitos persistentes, diarrea con sangre, deshidrataci√≥n o depresi√≥n marcada en un gatito, busca atenci√≥n inmediata.
        </p>

        <h3>Recursos</h3>
        <ul>
          <li><a href="https://www.avma.org" target="_blank" rel="noopener">American Veterinary Medical Association (AVMA)</a></li>
          <li><a href="https://www.vet.cornell.edu" target="_blank" rel="noopener">Cornell Feline Health Center</a></li>
        </ul>
      </div>
    </div>

    <div class="card">
      <h2>Preguntas frecuentes (FAQ)</h2>
      <h3>¬øLa panleucopenia es contagiosa para los humanos?</h3>
      <p>No ‚Äî el parvovirus felino afecta principalmente a los felinos. Sin embargo, sigue buenas pr√°cticas de higiene al manipular animales enfermos.</p>

      <h3>¬øCu√°nto dura la inmunidad tras la vacuna?</h3>
      <p>La duraci√≥n var√≠a por vacuna y edad; en general se recomiendan refuerzos anuales o seg√∫n la pauta del veterinario.</p>

      <h3>Si adopt√© un gato, ¬ølo puedo vacunar enseguida?</h3>
      <p>Consulta al veterinario: en muchos casos se inicia el protocolo de vacunaci√≥n y se recomienda mantener aislamiento temporal si hay riesgo.</p>
    </div>

  </section>

</div>

<footer>
  <p>Contenido informativo ‚Äî no sustituye la consulta veterinaria. Proyecto: Salud Felina.</p>
</footer>

<!-- FIREBASE y L√≥gica -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  GoogleAuthProvider,
  signInWithPopup,
  signInWithRedirect,
  getRedirectResult,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getDatabase,
  ref,
  push
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import {
  getFirestore,
  collection,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* CONFIGURACI√ìN FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyCdACTc1qQAFWDbkxnBnW58opthZgNytAs",
  authDomain: "login07540.firebaseapp.com",
  projectId: "login07540",
  storageBucket: "login07540.firebasestorage.app",
  messagingSenderId: "729426958528",
  appId: "1:729426958528:web:a2cc1a3aba1997e11f3525"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const dbRealtime = getDatabase(app);
const dbFirestore = getFirestore(app);

/* Elementos del DOM */
const email = document.getElementById("email");
const password = document.getElementById("password");
const msg = document.getElementById("authMsg");
const contenido = document.getElementById("contenido");
const loginSection = document.getElementById("loginSection");
const toggleBtn = document.getElementById("togglePassword");
const registerBtn = document.getElementById("registerBtn");
const pwBar = document.getElementById("pwBar");
const pwFeedback = document.getElementById("pwFeedback");
const reqLength = document.getElementById("req-length");
const reqClasses = document.getElementById("req-classes");

/* Toggle mostrar/ocultar contrase√±a (debajo del campo para que no tape) */
toggleBtn.addEventListener("click", (e) => {
  e.preventDefault();
  const type = password.type === "password" ? "text" : "password";
  password.type = type;
  toggleBtn.textContent = type === "password" ? "üëÅÔ∏è Mostrar contrase√±a" : "üôà Ocultar contrase√±a";
  toggleBtn.setAttribute("aria-pressed", type === "text");
});

/* Guardar registro en Realtime Database */
async function guardarRegistroRealtime(datos){
  try {
    const registrosRef = ref(dbRealtime, 'registros');
    await push(registrosRef, datos);
    console.log("Registro guardado en Realtime Database.");
  } catch (err) {
    console.error("Error guardando en Realtime Database:", err);
  }
}

/* Guardar registro en Firestore (colecci√≥n 'registros') */
async function guardarRegistroFirestore(datos){
  try {
    const col = collection(dbFirestore, 'registros');
    await addDoc(col, {
      ...datos,
      createdAt: serverTimestamp()
    });
    console.log("Registro guardado en Firestore (colecci√≥n 'registros').");
  } catch (err) {
    console.error("Error guardando en Firestore (colecci√≥n 'registros'):", err);
  }
}

/* Guardar visita en Firestore (nueva colecci√≥n 'visits') */
async function guardarVisitaFirestore(uid, email, provider){
  try {
    const col = collection(dbFirestore, 'visits');
    await addDoc(col, {
      uid: uid,
      email: email,
      provider: provider,
      visitedAt: serverTimestamp()
    });
    console.log("Visita registrada en Firestore (colecci√≥n 'visits').");
  } catch (err) {
    console.error("Error registrando visita en Firestore:", err);
  }
}

/* Escritura combinada (Realtime + Firestore) para registros iniciales */
async function guardarRegistroAmbos(datos){
  // No bloquear la UX por los writes; hacemos ambos, loggeando errores en consola
  guardarRegistroRealtime(datos);
  guardarRegistroFirestore(datos);
}

/* ===========================================================
   VALIDACI√ìN DE CONTRASE√ëAS (CLIENT-SIDE, INFORMACIONAL)
   - Pol√≠tica nivel "medio": >=8 caracteres y al menos 3 de 4 clases
   - IMPORTANTE: validar tambi√©n en servidor/servicio de auth en producci√≥n
   =========================================================== */
function evaluatePassword(pw) {
  const checks = {
    length: pw.length >= 8,
    lower: /[a-z]/.test(pw),
    upper: /[A-Z]/.test(pw),
    digit: /\d/.test(pw),
    special: /[!@#\$%\^\&*\)\(+=._-]/.test(pw)
  };
  const classesCount = [checks.lower, checks.upper, checks.digit, checks.special].filter(Boolean).length;

  // Reglas de "medio":
  const meetsMedium = checks.length && classesCount >= 3;
  // Fuerza estimada para indicador visual
  let score = 0;
  if (!pw) score = 0;
  else if (!checks.length) score = 1;
  else if (classesCount === 1) score = 1;
  else if (classesCount === 2) score = 2;
  else if (classesCount === 3) score = 3;
  else if (classesCount >= 4 && pw.length >= 10) score = 4;

  return { checks, classesCount, meetsMedium, score };
}

function updatePasswordUI() {
  const pw = password.value || "";
  const { checks, classesCount, meetsMedium, score } = evaluatePassword(pw);

  // Update requirements visuals
  reqLength.style.color = checks.length ? "#2f6b5d" : "#a29f9a";
  reqClasses.style.color = (classesCount >= 3) ? "#2f6b5d" : "#a29f9a";

  // Update meter
  const widths = [0, 20, 45, 70, 100];
  pwBar.style.width = widths[Math.min(score, widths.length - 1)] + "%";

  // Color gradient approximate
  if (score <= 1) pwBar.style.background = "linear-gradient(90deg,#ff6b6b,#ff8a65)";
  else if (score === 2) pwBar.style.background = "linear-gradient(90deg,#ffb857,#ffd54f)";
  else if (score === 3) pwBar.style.background = "linear-gradient(90deg,#9ccc65,#4caf50)";
  else pwBar.style.background = "linear-gradient(90deg,#42a5f5,#4caf50)";

  // Feedback text
  if (!pw) {
    pwFeedback.textContent = "Introduce una contrase√±a para ver la fuerza.";
  } else if (meetsMedium) {
    pwFeedback.textContent = "Contrase√±a aceptable (nivel medio). Puedes usar m√°s caracteres o clases para mayor seguridad.";
  } else {
    pwFeedback.textContent = "Contrase√±a demasiado d√©bil. Aumenta longitud y usa al menos 3 tipos (may√∫sculas, min√∫sculas, n√∫meros, s√≠mbolos).";
  }

  // Enable/disable register button
  registerBtn.disabled = !meetsMedium;
}

/* Eventos para actualizaci√≥n en tiempo real */
password.addEventListener("input", updatePasswordUI);
window.addEventListener("load", updatePasswordUI);

/* Registro con email y contrase√±a */
document.getElementById("registerBtn").onclick = async () => {
  msg.textContent = "";
  if (!email.value || !password.value) {
    msg.textContent = "Por favor completa correo y contrase√±a.";
    return;
  }

  // Validaci√≥n final antes de enviar
  const { meetsMedium } = evaluatePassword(password.value);
  if (!meetsMedium) {
    msg.textContent = "La contrase√±a no cumple la pol√≠tica m√≠nima. Revisa los requisitos.";
    return;
  }

  try{
    const userCredential = await createUserWithEmailAndPassword(auth, email.value, password.value);
    const user = userCredential.user;
    // Guardar en "registros" (ambos) SIN guardar la contrase√±a: solo metadata segura
    await guardarRegistroAmbos({
      uid: user.uid || null,
      email: user.email || email.value,
      provider: "password",
      createdAt: Date.now()
    });

    msg.textContent = "‚úÖ Correo registrado correctamente. Ya puedes iniciar sesi√≥n.";
  }catch(e){
    if(e.code === "auth/email-already-in-use"){
      msg.textContent = "‚ö†Ô∏è Correo ya registrado, intenta iniciar sesi√≥n.";
    } else if (e.code === "auth/invalid-email") {
      msg.textContent = "‚ö†Ô∏è Formato de correo inv√°lido.";
    } else if (e.code === "auth/weak-password") {
      // Firebase puede rechazar si su pol√≠tica es m√°s estricta
      msg.textContent = "‚ö†Ô∏è Contrase√±a considerada d√©bil por el proveedor. Usa una diferente.";
    } else {
      msg.textContent = e.message || "Error al registrar.";
    }
    console.error("Error register:", e);
  }
};

/* Inicio de sesi√≥n con email */
document.getElementById("loginBtn").onclick = async () => {
  msg.textContent = "";
  if (!email.value || !password.value) {
    msg.textContent = "Completa correo y contrase√±a para iniciar sesi√≥n.";
    return;
  }
  try{
    const userCredential = await signInWithEmailAndPassword(auth, email.value, password.value);
    const user = userCredential.user;
    // Guardamos metadata del login SIN almacenar la contrase√±a
    await guardarRegistroAmbos({
      uid: user.uid || null,
      email: user.email || email.value,
      provider: "password",
      createdAt: Date.now()
    });

    loginSection.style.display = "none";
    contenido.classList.remove("hidden");
    msg.textContent = "";
  }catch(e){
    // Mensaje gen√©rico por seguridad
    msg.textContent = "‚ùå Email o contrase√±a incorrectos.";
    console.error("Error signInWithEmail:", e);
  }
};

/* Inicio con Google: intento con popup; si falla por popup-blocked hacemos redirect */
document.getElementById("googleBtn").onclick = async () => {
  msg.textContent = "";
  const provider = new GoogleAuthProvider();
  try {
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    // Guardar entrada en 'registros' (ambos) - Para Google, no hay contrase√±a que almacenar
    await guardarRegistroAmbos({
      uid: user.uid || null,
      email: user.email || null,
      provider: "google",
      createdAt: Date.now()
    });
    loginSection.style.display = "none";
    contenido.classList.remove("hidden");
  } catch (e) {
    console.error("Error en signInWithPopup:", e);
    // Si el popup fue bloqueado o cerrado, intentamos redirect como fallback
    if (e.code === "auth/popup-blocked" || e.code === "auth/popup-closed-by-user") {
      try {
        msg.textContent = "El popup fue bloqueado o cerrado. Intentando con redirect...";
        await signInWithRedirect(auth, provider);
      } catch (errRedirect) {
        console.error("Error en signInWithRedirect:", errRedirect);
        msg.textContent = "No fue posible iniciar sesi√≥n con Google (redirect). Revisa consola.";
      }
    } else {
      if (e.code === "auth/cancelled-popup-request") {
        msg.textContent = "Operaci√≥n cancelada. Int√©ntalo de nuevo.";
      } else {
        msg.textContent = "Error al iniciar sesi√≥n con Google. Revisa la consola para m√°s detalles.";
      }
    }
  }
};

/* ---------------------------------------------------------
   Procesar redirect result y forzar signOut si NO hay login por redirect
   (comportamiento original mantenido)
   --------------------------------------------------------- */
(async function handleRedirectAndEnforceLogin(){
  try {
    const result = await getRedirectResult(auth);
    if (result && result.user) {
      const user = result.user;
      try {
        await guardarRegistroAmbos({
          uid: user.uid || null,
          email: user.email || null,
          provider: "google",
          createdAt: Date.now()
        });
      } catch(e){
        console.error("Error guardando registro despu√©s de redirect:", e);
      }
      loginSection.style.display = "none";
      contenido.classList.remove("hidden");
    } else {
      try {
        await signOut(auth);
        console.log("Sesi√≥n eliminada al cargar la p√°gina para exigir login cada vez.");
      } catch (soErr) {
        console.error("Error al forzar signOut:", soErr);
      }
    }
  } catch (err) {
    console.error("Error getRedirectResult:", err);
    try {
      await signOut(auth);
      console.log("Sesi√≥n eliminada tras error en getRedirectResult.");
    } catch (soErr) {
      console.error("Error al forzar signOut tras error:", soErr);
    }
  }
})();
/* --------------------------------------------------------- */

/* Detectar estado de autenticaci√≥n y registrar visitas (se mantiene) */
const VISIT_DEBOUNCE_TIME = 60 * 60 * 1000; // 1 hora en milisegundos

onAuthStateChanged(auth, async (user) => {
  if (user) {
    loginSection.style.display = "none";
    contenido.classList.remove("hidden");

    const lastVisitTimestamp = localStorage.getItem('lastRecordedVisit');
    const currentTime = Date.now();

    if (!lastVisitTimestamp || (currentTime - parseInt(lastVisitTimestamp, 10)) > VISIT_DEBOUNCE_TIME) {
      console.log("Registrando nueva visita para usuario autenticado.");
      await guardarVisitaFirestore(user.uid, user.email, user.providerData[0]?.providerId || "unknown");
      localStorage.setItem('lastRecordedVisit', currentTime.toString());
    } else {
      console.log("Visita no registrada: Dentro del per√≠odo de debounce.");
    }

  } else {
    loginSection.style.display = "";
    contenido.classList.add("hidden");
    localStorage.removeItem('lastRecordedVisit');
  }
});
</script>

</body>
</html>
